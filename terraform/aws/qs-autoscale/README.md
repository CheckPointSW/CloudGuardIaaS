# Check Point CloudGuard Network Quick Start Auto Scaling Terraform module for AWS

Terraform module which deploys a Check Point CloudGuard Network Security Gateway Auto Scaling Group, an external ALB/NLB, and optionally a Security Management Server and a web server Auto Scaling Group.

These types of Terraform resources are supported:
* [AWS Instance](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance)
* [Security Group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group)
* [Load Balancer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb)
* [Load Balancer Target Group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group)
* [Launch configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_configuration)
* [Auto Scaling Group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group)
* [IAM Role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) - conditional creation

See the [Check Point CloudGuard Auto Scaling on AWS](https://aws.amazon.com/quickstart/architecture/check-point-cloudguard/) for additional information

This solution uses the following modules:
- /terraform/aws/modules/autoscale
- /terraform/aws/modules/custom_autoscale
- /terraform/aws/modules/management
- /terraform/aws/modules/cme-iam-role

## Configurations

The **main.tf** file includes the following provider configuration block used to configure the credentials for the authentication with AWS, as well as a default region for your resources:
```
provider "aws" {
    region = var.region
    access_key = var.aws_access_key_ID
    secret_key = var.aws_secret_access_key
}
```
The provider credentials can be provided either as static credentials or as [Environment Variables](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#environment-variables).
- Static credentials can be provided by adding an access_key and secret_key in /terraform/aws/qs-autoscale/**terraform.tfvars** file as follows:
```
region     = "us-east-1"
access_key = "my-access-key"
secret_key = "my-secret-key"
```
- In case the Static credentials are used, perform modifications described below:<br/>
  a. The next lines in main.tf file, in the provider aws resource, need to be commented for sub-modules /terraform/aws/autoscale, /terraform/aws/modules/management and /terraform/aws/modules/cme-iam-role:
  ```
  provider "aws" {
  //  region = var.region
  //  access_key = var.access_key
  //  secret_key = var.secret_key
  }
  ```
- In case the Environment Variables are used, perform modifications described below:<br/>
  a. The next lines in main.tf file, in the provider aws resource, need to be commented:
  ```
  provider "aws" {
  //    region = var.region
  //    access_key = var.aws_access_key_ID
  //    secret_key = var.aws_secret_access_key
  }
  ```
  b. The next lines in main.tf file, in the provider aws resource, need to be commented for sub-modules /terraform/aws/autoscale, /terraform/aws/modules/management and /terraform/aws/modules/cme-iam-role:
  ```
  provider "aws" {
  //    region = var.region
  //    access_key = var.aws_access_key_ID
  //    secret_key = var.aws_secret_access_key
  }
  ```
 
## Usage
- Fill all variables in the /terraform/aws/qs-autoscale/**terraform.tfvars** file with proper values (see below for variables descriptions).
- From a command line initialize the Terraform configuration directory:
    ```
    terraform init
    ```
- Create an execution plan:
    ```
    terraform plan
    ```
- Create or modify the deployment:
    ```
    terraform apply
    ```
  
- Variables are configured in /terraform/aws/qs-autoscale/**terraform.tfvars** file as follows:

  ```
    //PLEASE refer to README.md for accepted values FOR THE VARIABLES BELOW

    // --- Environment ---
    prefix = "TF"
    asg_name = "asg-qs"

    // --- General Settings ---
    vpc_id = "vpc-12345678"
    key_name = "privatekey"
    enable_volume_encryption = true
    enable_instance_connect = false
    allow_upload_download = true
    provision_tag = "quickstart"
    load_balancers_type = "Application Load Balancer"
    load_balancer_protocol = "HTTP"
    certificate = ""
    service_port = "80"

    // --- Check Point CloudGuard Network Security Gateways Auto Scaling Group Configuration ---
    gateways_subnets = ["subnet-123b5678", "subnet-123a4567"]
    gateway_instance_type = "c5.xlarge"
    gateways_min_group_size = 2
    gateways_max_group_size = 8
    gateway_version = "R81-BYOL"
    gateway_password_hash = "12345678"
    gateway_SICKey = ""
    enable_cloudwatch = true

    // --- Check Point CloudGuard Network Security Management Server Configuration ---
    management_deploy = true
    management_instance_type = "m5.xlarge"
    management_version = "R80.40-PAYG"
    management_password_hash = "12345678"
    gateways_policy = "Standard"
    gateways_blades = true
    admin_cidr = "0.0.0.0/0"
    gateways_addresses = "0.0.0.0/0"

    // --- Web Servers Auto Scaling Group Configuration ---
    servers_deploy = false
    servers_subnets = ["subnet-1234abcd", "subnet-56789def"]
    servers_instance_type = "t3.micro"
    server_ami = "ami-12345678"
  ```

- Conditional creation
  - To enable cloudwatch for ASG:
  ```
  enable_cloudwatch = true
  ```
  Note: enabling cloudwatch will automatically create IAM role with cloudwatch:PutMetricData permission
  - To deploy Security Management Server:
  ```
  management_deploy = true
  ```
  - To deploy web servers:
  ```
  servers_deploy = true
  ```
  - To create an ASG configuration without a proxy ELB:
  ```
  proxy_elb_type= "none"
  ```
- To tear down your resources:
    ```
    terraform destroy
    ```

## Inputs
| Name                     | Description                                                                                                                                                                             | Type         | Allowed values                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Default               | Required |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|----------|
| prefix                   | (Optional) Instances name prefix                                                                                                                                                        | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ""                    | no       |
| asg_name                 | Autoscaling Group name                                                                                                                                                                  | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Check-Point-ASG-tf    | no       |
| vpc_id                   | Select an existing VPC                                                                                                                                                                  | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |
| key_name                 | The EC2 Key Pair name to allow SSH access to the instances                                                                                                                              | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |
| enable_volume_encryption | Encrypt Environment instances volume with default AWS KMS key                                                                                                                           | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | true                  | no       |
| enable_instance_connect  | Enable SSH connection over AWS web console. Supporting regions can be found [here](https://aws.amazon.com/about-aws/whats-new/2019/06/introducing-amazon-ec2-instance-connect/)         | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | false                 | no       |
| allow_upload_download    | Automatically download Blade Contracts and other important data. Improve product experience by sending data to Check Point                                                              | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | true                  | no       |
| provision_tag            | The tag is used by the Security Management Server to automatically provision the Security Gateways. Must be up to 12 alphanumeric characters and unique for each Quick Start deployment | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | quickstart            | no       |
| load_balancers_type      | Use Network Load Balancer if you wish to preserve the source IP address and Application Load Balancer if you wish to use content based routing                                          | string       | - Network Load Balancer <br/> - Application Load Balancer <br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Network Load Balancer | no       |
| load_balancer_protocol   | The protocol to use on the Load Balancer                                                                                                                                                | string       | Network Load Balancer: <br/> - TCP <br/> - TLS <br/> - UDP <br/> - TCP_UDP <br/> <br/> Application Load Balancer: <br/> - HTTP <br/> - HTTPS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | TCP                   | yes      |
| certificate              | Amazon Resource Name (ARN) of an HTTPS Certificate, ignored if the selected protocol is HTTP                                                                                            | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | no       |
| service_port             | The external Load Balancer listens to this port. Leave this field blank to use default ports: 80 for HTTP and 443 for HTTPS                                                             | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | no       |
| gateways_subnets         | Select at least 2 public subnets in the VPC. If you choose to deploy a Security Management Server it will be deployed in the first subnet                                               | list(string) | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |
| gateway_instance_type    | The instance type of the Security Gateways                                                                                                                                              | string       | - c5.large <br/> - c5.xlarge <br/> - c5.2xlarge <br/> - c5.4xlarge <br/> - c5.9xlarge <br/> - c5.18xlarge <br/> - c5n.large <br/> - c5n.xlarge <br/> - c5n.2xlarge <br/> - c5n.4xlarge <br/> - c5n.9xlarge <br/> - c5n.18xlarge <br/> - m5.large <br/> - m5.xlarge <br/> - m5.2xlarge <br/> - m5.4xlarge <br/> - m5.8xlarge <br/> - m5.12xlarge <br/> - m6i.large <br/> - m6i.xlarge <br/> - m6i.2xlarge <br/> - m6i.4xlarge <br/> - m6i.12xlarge <br/> - m6i.24xlarge <br/> - c6i.large <br/> - c6i.xlarge <br/> - c6i.2xlarge <br/> - c6i.4xlarge <br/> - c6i.12xlarge <br/> - c6i.24xlarge <br/> - r5.large <br/> - r5.xlarge <br/> - r5.2xlarge <br/> - r5.4xlarge <br/> - r5.12xlarge <br/> - r5.24xlarge <br/> - r5a.large <br/> - r5a.xlarge <br/> - r5a.2xlarge <br/> - r5a.4xlarge <br/> - r5a.12xlarge <br/> - r5a.24xlarge <br/> - r5b.large <br/> - r5b.xlarge <br/> - r5b.2xlarge <br/> - r5b.4xlarge <br/> - r5b.12xlarge <br/> - r5b.24xlarge <br/> - r5n.large <br/> - r5n.xlarge <br/> - r5n.2xlarge <br/> - r5n.4xlarge <br/> - r5n.12xlarge <br/> - r5n.24xlarge <br/> - m6a.large <br/> - m6a.xlarge <br/> - m6a.2xlarge  <br/> - m6a.4xlarge <br/> - m6a.12xlarge <br/> - m6a.24xlarge                    | c5.xlarge             | no       |
| gateways_min_group_size  | The minimal number of Security Gateways                                                                                                                                                 | number       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 2                     | no       |
| gateways_max_group_size  | The maximal number of Security Gateways                                                                                                                                                 | number       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 10                    | no       |
| gateway_version          | Gateway version and license                                                                                                                                                             | string       | - R80.40-BYOL <br/> - R80.40-PAYG-NGTP <br/> - R80.40-PAYG-NGTX <br/> - R81-BYOL <br/> - R81-PAYG-NGTP <br/> - R81-PAYG-NGTX <br/> - R81.10-BYOL <br/> - R81.10-PAYG-NGTP <br/> - R81.10-PAYG-NGTX                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | R81-BYOL              | no       |
| gateway_password_hash    | (Optional) Admin user's password hash (use command 'openssl passwd -6 PASSWORD' to get the PASSWORD's hash)                                                                             | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ""                    | no       |
| gateway_SIC_Key          | The Secure Internal Communication key for trusted connection between Check Point components. Choose a random string consisting of at least 8 alphanumeric characters                    | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |
| enable_cloudwatch        | Report Check Point specific CloudWatch metrics                                                                                                                                          | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | false                 | no       |
| management_deploy        | Select 'false' to use an existing Security Management Server or to deploy one later and to ignore the other parameters of this section                                                  | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | true                  | no       |
| management_instance_type | The instance type of the Security Management Server                                                                                                                                     | string       | - c5.large <br/> - c5.xlarge <br/> - c5.2xlarge <br/> - c5.4xlarge <br/> - c5.9xlarge <br/> - c5.18xlarge <br/> - c5n.large <br/> - c5n.xlarge <br/> - c5n.2xlarge <br/> - c5n.4xlarge <br/> - c5n.9xlarge <br/> - c5n.18xlarge <br/> - m5.large <br/> - m5.xlarge <br/> - m5.2xlarge <br/> - m5.4xlarge <br/> - m5.8xlarge <br/> - m5.12xlarge <br/> - m5.24xlarge <br/> - m6i.large <br/> - m6i.xlarge <br/> - m6i.2xlarge <br/> - m6i.4xlarge <br/> - m6i.12xlarge <br/> - m6i.24xlarge <br/> - c6i.large <br/> - c6i.xlarge <br/> - c6i.2xlarge <br/> - c6i.4xlarge <br/> - c6i.12xlarge <br/> - c6i.24xlarge <br/> - r5.large <br/> - r5.xlarge <br/> - r5.2xlarge <br/> - r5.4xlarge <br/> - r5.12xlarge <br/> - r5.24xlarge <br/> - r5a.large <br/> - r5a.xlarge <br/> - r5a.2xlarge <br/> - r5a.4xlarge <br/> - r5a.12xlarge <br/> - r5a.24xlarge <br/> - r5b.large <br/> - r5b.xlarge <br/> - r5b.2xlarge <br/> - r5b.4xlarge <br/> - r5b.12xlarge <br/> - r5b.24xlarge <br/> - r5n.large <br/> - r5n.xlarge <br/> - r5n.2xlarge <br/> - r5n.4xlarge <br/> - r5n.12xlarge <br/> - r5n.24xlarge <br/> - m6a.large <br/> - m6a.xlarge <br/> - m6a.2xlarge <br/> - m6a.4xlarge <br/> - m6a.12xlarge <br/> - m6a.24xlarge | m5.xlarge             | no       |
| management_version       | The license to install on the Security Management Server                                                                                                                                | string       | - R80.40-BYOL <br/> - R80.40-PAYG <br/> - R81-BYOL <br/> - R81-PAYG <br/> - R81.10-BYOL <br/> - R81.10-PAYG                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | R80.40-PAYG           | no       |
| management_password_hash | (Optional) Admin user's password hash (use command 'openssl passwd -6 PASSWORD' to get the PASSWORD's hash)                                                                             | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ""                    | no       |
| gateways_policy          | The name of the Security Policy package to be installed on the gateways in the Security Gateways Auto Scaling group                                                                     | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Standard              | no       |
| gateways_blades          | Turn on the Intrusion Prevention System, Application Control, Anti-Virus and Anti-Bot Blades (additional Blades can be manually turned on later)                                        | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | true                  | no       |
| admin_cidr               | (CIDR) Allow web, ssh, and graphical clients only from this network to communicate with the Management Server                                                                           | string       | valid CIDR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | n/a                   | no       |
| gateway_addresses        | (CIDR) Allow gateways only from this network to communicate with the Management Server                                                                                                  | string       | valid CIDR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | n/a                   | no       |
| servers_deploy           | Select 'true' to deploy web servers and an internal Application Load Balancer. If you select 'false' the other parameters of this section will be ignored                               | bool         | true/false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | false                 | no       |
| servers_subnets          | Provide at least 2 private subnet IDs in the chosen VPC, separated by commas (e.g. subnet-0d72417c,subnet-1f61306f,subnet-1061d06f).                                                    | list(string) | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |
| servers_instance_type    | The EC2 instance type for the web servers                                                                                                                                               | string       | - t3.nano <br/> - t3.micro <br/> - t3.small <br/> - t3.medium <br/> - t3.large <br/> - t3.xlarge <br/> - t3.2xlarge                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | t3.micro              | no       |
| server_ami               | The Amazon Machine Image ID of a preconfigured web server (e.g. ami-0dc7dc63)                                                                                                           | string       | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | n/a                   | yes      |


## Outputs
| Name  | Description |
| ------------- | ------------- |
| management_name  | The deployed Security Management AWS instance name |
| internal_port  | The internal Load Balancer should listen to this port  |
| load_balancer_url  | The URL of the external Load Balancer  |
| external_load_balancer_arn  | The external Load Balancer arn  |
| internal_load_balancer_arn  | The internal Load Balancer arn  |
| external_LB_target_group_arn  | The external Load Balancer Target Group arn  |
| internal_LB_target_group_arn  | The internal Load Balancer Target Group arn  |
| autoscale_autoscaling_group_name  | The name of the deployed AutoScaling Group  |
| autoscale_autoscaling_group_arn  | The ARN for the deployed AutoScaling Group  |
| autoscale_security_group_id  | The deployed AutoScaling Group's security group id  |
| autoscale_iam_role_name  | The deployed AutoScaling Group's IAM role name (if created)  |
| configuration_template  | The name that represents the configuration template. Configurations required to automatically provision the Gateways in the Auto Scaling Group, such as what Security Policy to install and which Blades to enable, will be placed under this template name  |
| controller_name  | The name that represents the controller. Configurations required to connect to your AWS environment, such as credentials and regions, will be placed under this controller name  |

## Revision History
In order to check the template version, please refer to [sk116585](https://supportcenter.checkpoint.com/supportcenter/portal?eventSubmit_doGoviewsolutiondetails=&solutionid=sk116585)

| Template Version | Description                                                                    |
|------------------|--------------------------------------------------------------------------------|
| 20210309         | First release of Check Point Quick Start Auto Scaling Terraform module for AWS |
| 20210329         | Stability fixes                                                                |
| 20220606         | New instance type support                                                      |



## License

This project is licensed under the MIT License - see the [LICENSE](../../LICENSE) file for details
